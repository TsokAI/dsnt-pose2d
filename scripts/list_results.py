#!/usr/bin/env python3

"""
This script will print results generated by batch_infer.py
"""

import os
import re
from itertools import groupby
import tabulate
import json


def main():
    groups = [
        {'name': 'Varying depth', 'pattern': '^depth-'},
        {'name': 'Different output strategies', 'pattern': '^outstrat-'},
        {'name': 'Different heatmap activations', 'pattern': '^preact-'},
    ]

    in_dir = 'out/by-alias'
    subset = 'val'

    pairs = [(re.match('^(\w+)', f).group(1), f) for f in os.listdir(in_dir)]

    headers = ['Name', 'PCKh total', 't (ms)', 't_err (ms)', 'ID']

    for group_name, aliases in groupby(sorted(pairs), lambda p: p[0]):
        files = [(f, os.path.realpath(os.path.join(in_dir, f))) for (_, f) in aliases]
        exp_dirs = [pair for pair in files if os.path.isdir(pair[1])]

        rows = []

        for name, exp_dir in exp_dirs:
            metrics_file = os.path.join(exp_dir, 'infer-{}-metrics.json'.format(subset))

            if not os.path.isfile(metrics_file):
                print('cannot find metrics file, skipping')
                continue

            with open(metrics_file, 'r') as f:
                metrics = json.load(f)

            with open(os.path.join(exp_dir, 'notebook_details.json'), 'r') as f:
                notebook = json.load(f)

            rows.append([
                name,
                metrics['accuracy_pckh']['total_mpii'],
                metrics['inference_time_ms']['median'],
                metrics['inference_time_ms']['error'],
                notebook['notebook_id'],
            ])

        print()
        print('# ' + group_name)
        print()
        print(tabulate.tabulate(rows, headers))


if __name__ == '__main__':
    main()
